<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.acorn.ReviewMapper"> 
    <!-- 리뷰 전체 조회 -->
    <select id="selectReviewsByContentId" resultType="ReviewDTO" parameterType="String">
        SELECT r.reviewcode, r.content, u.userid,
               CASE
                   WHEN LENGTH(u.nickname) = 2 THEN SUBSTR(u.nickname, 1, 1) || '*'
                   ELSE SUBSTR(u.nickname, 1, 1) || LPAD('*', LENGTH(u.nickname) - 2, '*') || SUBSTR(u.nickname, -1)
               END AS nickname,
               u.profileurl,
               TO_CHAR(r.WRITEDAY, 'yyyy.mm.dd') AS writeday
        FROM reviewtbl r JOIN usertbl u ON r.userid = u.userid
        WHERE contentid = #{contentid} AND parentcode = 0
        ORDER BY reviewcode DESC
    </select>

    <!-- 리뷰 등록 -->
    <insert id="insertReview" parameterType="map">
	    INSERT INTO reviewtbl(reviewcode, userid, content, writeday, contentid, parentcode)
	    VALUES (reviewnumber.NEXTVAL, #{userid}, #{content}, sysdate, #{contentid}, '0')
	</insert>

    <!-- 리뷰 수정 -->
    <update id="updateReview" parameterType="ReviewDTO">
        UPDATE reviewtbl SET content = #{content} WHERE reviewcode = #{reviewcode}
    </update>

    <!-- 리뷰 삭제 -->
    <delete id="deleteReview" parameterType="int">
        DELETE FROM reviewtbl WHERE reviewcode = #{reviewcode}
    </delete>

    <!-- 답글 조회 -->
    <select id="selectReplyByParentCode" resultType="ReviewDTO" parameterType="int">
        SELECT r.reviewcode, r.userid, r.content, TO_CHAR(r.writeday, 'yyyy.mm.dd') AS writeday,
               r.contentid, r.parentcode, SUBSTR(u.nickname, 1, 1) || LPAD(SUBSTR(u.nickname, LENGTH(u.nickname), 1), LENGTH(u.nickname), '*') AS nickname
        FROM reviewtbl r JOIN usertbl u ON r.userid = u.userid
        WHERE parentcode = #{parentcode}
        ORDER BY reviewcode
    </select>

    <!-- 답글 등록 -->
    <insert id="insertReply" parameterType="ReviewDTO">
        INSERT INTO reviewtbl(reviewcode, userid, content, writeday, contentid, parentcode)
        VALUES (reviewnumber.NEXTVAL, #{userid}, #{content}, sysdate, #{contentid}, #{parentcode})
    </insert>

    <!-- 답글 수정 -->
    <update id="updateReply" parameterType="ReviewDTO">
        UPDATE reviewtbl SET content = #{content} WHERE reviewcode = #{reviewcode}
    </update>

    <!-- 답글 삭제 -->
    <delete id="deleteReply" parameterType="int">
        DELETE FROM reviewtbl WHERE reviewcode = #{reviewcode}
    </delete>

    
 
</mapper>